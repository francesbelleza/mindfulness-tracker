{% extends "base.html" %}
{% block title %}Journal Reflection{% endblock %}

{% block content %}
<div class="reflect-container">
  <div class="text-center mb-4">
    <h1 class="display-5 mb-2">
      Time to Reflect
    </h1>
    <p class="subtitle">Write or speak your thoughts</p>
  </div>

  <!-- Journal Prompt Card -->
  <div class="prompt-card mx-auto mb-4">
    <h3 class="prompt-heading">Journal Prompt of the Day</h3>
    <p class="prompt-text">{{ practice.journal_prompt }}</p>
  </div>

  <!-- Journal Entry Form -->
  <form method="POST" action="{{ url_for('reflect') }}" class="mx-auto" style="max-width: 700px;">

    <!-- AI-Generated Prompt Response -->
    <div class="mb-5">
      <label class="form-label mb-3" style="font-weight: 300;">Your Reflection</label>

      <button type="button" id="speakBtn" class="speak-btn mb-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;">
          <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
          <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5z"/>
        </svg>
        Speak
      </button>

      <!-- Voice Recording Status -->
      <div id="recordingStatus" class="recording-status" style="display: none;">
        <div class="recording-indicator">
          <span class="pulse-dot"></span>
          <span>Listening...</span>
        </div>
        <button type="button" id="stopBtn" class="btn btn-sm btn-danger">Stop Recording</button>
      </div>
      <textarea
        name="entry_text"
        id="journalEntry"
        class="form-control journal-textarea"
        rows="6"
        placeholder="Share your thoughts... You can type or use the microphone to speak."
        required>{% if existing_entry %}{{ existing_entry.entry_text }}{% endif %}</textarea>
      <small class="text-muted">
        <span id="charCount">0</span> characters
      </small>
    </div>

    <!-- Morning-Specific Questions -->
    {% if practice.checkin.time_of_day == 'Morning' %}
    <div class="mb-4">
      <label class="form-label" style="font-weight: 500;">What is your intention for the day?</label>
      <input
        type="text"
        name="intention_for_day"
        class="form-control journal-input"
        placeholder="Your intention for today..."
        value="{% if existing_entry %}{{ existing_entry.intention_for_day or '' }}{% endif %}"
        required>
    </div>
    {% endif %}

    <!-- Night-Specific Questions -->
    {% if practice.checkin.time_of_day == 'Night' %}
    <div class="mb-4">
      <label class="form-label" style="font-weight: 500;">What is one thing you did for yourself today?</label>
      <input
        type="text"
        name="self_care_today"
        class="form-control journal-input"
        placeholder="Something you did for yourself..."
        value="{% if existing_entry %}{{ existing_entry.self_care_today or '' }}{% endif %}"
        required>
    </div>

    <div class="mb-4">
      <label class="form-label" style="font-weight: 500;">What is one thing you'd like to accomplish tomorrow?</label>
      <input
        type="text"
        name="goal_for_tomorrow"
        class="form-control journal-input"
        placeholder="Your goal for tomorrow..."
        value="{% if existing_entry %}{{ existing_entry.goal_for_tomorrow or '' }}{% endif %}"
        required>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="button-group">
      <a href="{{ url_for('practice') }}" class="btn btn-secondary btn-lg">
        Back to Practice
      </a>
      <button type="submit" class="btn btn-primary btn-lg">
        Save & Continue
      </button>
    </div>
  </form>
</div>

<style>
.reflect-container {
  padding: var(--space-2xl) var(--space-lg);
  max-width: 900px;
  margin: 0 auto;
  min-height: 80vh;
}

.reflect-container h1 {
  color: var(--text-light);
  font-weight: 200;
  letter-spacing: 1px;
}

.subtitle {
  color: var(--text-medium);
  font-size: 1.1rem;
  font-weight: 300;
  letter-spacing: 0.5px;
}

/* Prompt Card - Burnt orange */
.prompt-card {
  background: rgba(165, 99, 54, 0.3);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(232, 168, 124, 0.3);
  border-radius: var(--radius-xl);
  padding: var(--space-2xl);
  box-shadow: var(--shadow-card), var(--glow-subtle);
  max-width: 700px;
  text-align: center;
}

.prompt-heading {
  font-size: 1.2rem;
  font-weight: 300;
  color: var(--text-light);
  margin-bottom: var(--space-md);
  letter-spacing: 1px;
}

.prompt-text {
  font-size: 1.15rem;
  color: var(--text-medium);
  line-height: 1.9;
  font-style: italic;
  margin: 0;
  font-weight: 300;
}

/* Form Label */
.form-label {
  font-weight: 300;
  font-size: 1.05rem;
  color: var(--text-medium);
  letter-spacing: 0.5px;
  display: block;
}

/* Speak Button - Redesigned */
.speak-btn {
  background: linear-gradient(135deg, var(--sunset-peach) 0%, var(--sunset-coral) 100%);
  color: var(--bg-primary);
  border: none;
  border-radius: var(--radius-lg);
  padding: 10px 24px;
  font-size: 0.9rem;
  font-weight: 300;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: var(--transition-smooth);
  box-shadow: var(--glow-subtle);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.speak-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--glow-medium);
}

.speak-btn.active {
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  color: white;
  box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
}

.speak-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
}

/* Recording Status */
.recording-status {
  background: rgba(232, 168, 124, 0.1);
  border: 1px solid rgba(232, 168, 124, 0.3);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  margin-bottom: var(--space-md);
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: blur(10px);
}

.recording-indicator {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  font-weight: 300;
  color: var(--text-accent);
  letter-spacing: 0.5px;
}

.pulse-dot {
  width: 10px;
  height: 10px;
  background: #e74c3c;
  border-radius: var(--radius-full);
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.5;
    transform: scale(1.2);
  }
}

/* Journal Textarea - Journal-like styling */
.journal-textarea {
  background: rgba(38, 60, 65, 0.3);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(232, 168, 124, 0.2);
  border-radius: var(--radius-lg);
  padding: var(--space-lg);
  font-size: 1.1rem;
  font-weight: 300;
  line-height: 2;
  letter-spacing: 0.3px;
  color: var(--text-light);
  resize: vertical;
  min-height: 200px;
  transition: var(--transition-smooth);
  box-shadow: var(--shadow-soft);
}

.journal-textarea:focus {
  background: rgba(38, 60, 65, 0.5);
  border-color: var(--sunset-peach);
  box-shadow: var(--shadow-card), var(--glow-subtle);
  outline: none;
}

.journal-textarea::placeholder {
  color: var(--text-subtle);
  font-style: italic;
}

/* Journal Input Fields */
.journal-input {
  background: rgba(38, 60, 65, 0.3);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(232, 168, 124, 0.2);
  border-radius: var(--radius-md);
  padding: 14px 18px;
  font-size: 1rem;
  font-weight: 300;
  color: var(--text-light);
  letter-spacing: 0.3px;
  transition: var(--transition-smooth);
  box-shadow: var(--shadow-soft);
}

.journal-input:focus {
  background: rgba(38, 60, 65, 0.5);
  border-color: var(--sunset-peach);
  box-shadow: 0 0 0 3px rgba(232, 168, 124, 0.1);
  outline: none;
}

.journal-input::placeholder {
  color: var(--text-subtle);
}

/* Character count styling */
.text-muted {
  color: var(--text-subtle) !important;
  font-size: 0.85rem;
  font-weight: 300;
  letter-spacing: 0.3px;
}

/* Button Group */
.button-group {
  display: flex;
  gap: var(--space-md);
  justify-content: center;
}

/* Responsive */
@media (max-width: 576px) {
  .reflect-container {
    padding: 40px 16px;
  }

  .prompt-card {
    padding: var(--space-lg);
  }

  .button-group {
    flex-direction: column;
  }

  .btn-lg {
    width: 100%;
  }
}
</style>

<script>
// Web Speech API Integration
const speakBtn = document.getElementById('speakBtn');
const journalEntry = document.getElementById('journalEntry');
const recordingStatus = document.getElementById('recordingStatus');
const stopBtn = document.getElementById('stopBtn');
const charCount = document.getElementById('charCount');

// Initialize character count
function updateCharCount() {
  charCount.textContent = journalEntry.value.length;
}
updateCharCount();
journalEntry.addEventListener('input', updateCharCount);

// Check if browser supports Web Speech API
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
let isRecording = false;

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  let finalTranscript = '';
  let interimTranscript = '';

  recognition.onstart = function() {
    isRecording = true;
    recordingStatus.style.display = 'flex';
    speakBtn.textContent = 'ðŸ”´ Recording...';
    speakBtn.classList.add('active');
  };

  recognition.onresult = function(event) {
    interimTranscript = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;

      if (event.results[i].isFinal) {
        finalTranscript += transcript + ' ';
      } else {
        interimTranscript += transcript;
      }
    }

    // Update textarea with final + interim results
    journalEntry.value = finalTranscript + interimTranscript;
    updateCharCount();
  };

  recognition.onerror = function(event) {
    console.error('Speech recognition error:', event.error);
    stopRecording();

    if (event.error === 'not-allowed') {
      alert('Microphone access denied. Please enable microphone permissions in your browser settings.');
    } else if (event.error === 'no-speech') {
      alert('No speech detected. Please try again.');
    }
  };

  recognition.onend = function() {
    if (isRecording) {
      // Auto-restart if still in recording mode
      recognition.start();
    } else {
      stopRecording();
    }
  };

  // Speak button click
  speakBtn.addEventListener('click', function() {
    if (!isRecording) {
      startRecording();
    } else {
      stopRecording();
    }
  });

  // Stop button click
  stopBtn.addEventListener('click', function() {
    stopRecording();
  });

  function startRecording() {
    try {
      // Store current text before starting
      finalTranscript = journalEntry.value;
      recognition.start();
    } catch (error) {
      console.error('Failed to start recording:', error);
      alert('Failed to start recording. Please try again.');
    }
  }

  function stopRecording() {
    isRecording = false;
    recognition.stop();
    recordingStatus.style.display = 'none';
    speakBtn.textContent = 'ðŸŽ¤ Speak';
    speakBtn.classList.remove('active');
  }
} else {
  // Disable speak button if Web Speech API not supported
  speakBtn.disabled = true;
  speakBtn.textContent = 'ðŸŽ¤ Not Supported';
}

// Make sure we stop recording when leaving the page
window.addEventListener('beforeunload', function() {
  if (isRecording && recognition) {
    stopRecording();
  }
});
</script>
{% endblock %}
