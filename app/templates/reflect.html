{% extends "base.html" %}
{% block title %}Journal Reflection{% endblock %}

{% block content %}
<div class="reflect-container">
  <div class="text-center mb-4">
    <div class="journal-icon mb-3">üìù</div>
    <h1 class="display-5 mb-2" style="color: #C3521A; font-weight: 600;">
      Time to Reflect
    </h1>
    <p class="text-muted">Write or speak your thoughts</p>
  </div>

  <!-- Journal Prompt Card -->
  <div class="prompt-card mx-auto mb-4">
    <div class="prompt-icon mb-3">üí≠</div>
    <h3 class="prompt-heading">Journal Prompt of the Day</h3>

    <!-- AI-Generated Prompt -->
    <p class="prompt-text">{{ practice.journal_prompt }}</p>
  </div>

  <!-- Journal Entry Form -->
  <form method="POST" action="{{ url_for('reflect') }}" class="mx-auto" style="max-width: 700px;">

    <!-- AI-Generated Prompt Response -->
    <div class="mb-4">
      <div class="label-with-speak">
        <label class="form-label" style="font-weight: 500;">Your Reflection</label>
        <button type="button" id="speakBtn" class="speak-btn">
          üé§ Speak
        </button>
      </div>

      <!-- Voice Recording Status -->
      <div id="recordingStatus" class="recording-status" style="display: none; margin-bottom: 12px;">
        <div class="recording-indicator">
          <span class="pulse-dot"></span>
          <span>Listening...</span>
        </div>
        <button type="button" id="stopBtn" class="btn btn-sm btn-danger">Stop Recording</button>
      </div>
      <textarea
        name="entry_text"
        id="journalEntry"
        class="form-control journal-textarea"
        rows="6"
        placeholder="Share your thoughts... You can type or use the microphone to speak."
        required>{% if existing_entry %}{{ existing_entry.entry_text }}{% endif %}</textarea>
      <small class="text-muted">
        <span id="charCount">0</span> characters
      </small>
    </div>

    <!-- Morning-Specific Questions -->
    {% if practice.checkin.time_of_day == 'Morning' %}
    <div class="mb-4">
      <label class="form-label" style="font-weight: 500;">What is your intention for the day?</label>
      <input
        type="text"
        name="intention_for_day"
        class="form-control journal-input"
        placeholder="Your intention for today..."
        value="{% if existing_entry %}{{ existing_entry.intention_for_day or '' }}{% endif %}"
        required>
    </div>
    {% endif %}

    <!-- Night-Specific Questions -->
    {% if practice.checkin.time_of_day == 'Night' %}
    <div class="mb-4">
      <label class="form-label" style="font-weight: 500;">What is one thing you did for yourself today?</label>
      <input
        type="text"
        name="self_care_today"
        class="form-control journal-input"
        placeholder="Something you did for yourself..."
        value="{% if existing_entry %}{{ existing_entry.self_care_today or '' }}{% endif %}"
        required>
    </div>

    <div class="mb-4">
      <label class="form-label" style="font-weight: 500;">What is one thing you'd like to accomplish tomorrow?</label>
      <input
        type="text"
        name="goal_for_tomorrow"
        class="form-control journal-input"
        placeholder="Your goal for tomorrow..."
        value="{% if existing_entry %}{{ existing_entry.goal_for_tomorrow or '' }}{% endif %}"
        required>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="button-group">
      <a href="{{ url_for('practice') }}" class="btn btn-secondary btn-lg">
        Back to Practice
      </a>
      <button type="submit" class="btn btn-primary btn-lg">
        Save & Continue
      </button>
    </div>
  </form>
</div>

<style>
.reflect-container {
  padding: 60px 20px;
  max-width: 900px;
  margin: 0 auto;
  min-height: 70vh;
}

.journal-icon {
  font-size: 4rem;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

/* Prompt Card */
.prompt-card {
  background: linear-gradient(135deg, #fff9f5 0%, #fff 100%);
  border: 2px solid #f8e8df;
  border-radius: 20px;
  padding: 32px;
  box-shadow: 0 3px 12px rgba(195, 82, 26, 0.06);
  max-width: 700px;
  text-align: center;
}

.prompt-icon {
  font-size: 2.5rem;
  opacity: 0.8;
}

.prompt-heading {
  font-size: 1.3rem;
  font-weight: 600;
  color: #C3521A;
  margin-bottom: 16px;
}

.prompt-text {
  font-size: 1.15rem;
  color: #495057;
  line-height: 1.7;
  font-style: italic;
  margin: 0 0 20px 0;
}

.prompt-text:last-child {
  margin-bottom: 0;
}

.additional-prompts {
  margin-top: 24px;
  padding-top: 24px;
  border-top: 2px solid #f8e8df;
}

.additional-prompts .prompt-text {
  font-weight: 500;
}

/* Label with Speak Button */
.label-with-speak {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.speak-btn {
  background: linear-gradient(135deg, #5a67d8 0%, #7c3aed 100%);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(90, 103, 216, 0.2);
}

.speak-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(90, 103, 216, 0.3);
}

.speak-btn.active {
  background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  box-shadow: 0 4px 12px rgba(197, 48, 48, 0.4);
}

.speak-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Recording Status */
.recording-status {
  background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
  border: 2px solid #81c784;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.recording-indicator {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 500;
  color: #2e7d32;
}

.pulse-dot {
  width: 12px;
  height: 12px;
  background: #f44336;
  border-radius: 50%;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.5;
    transform: scale(1.2);
  }
}

/* Journal Textarea */
.journal-textarea {
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  font-size: 1.05rem;
  line-height: 1.8;
  resize: vertical;
  transition: all 0.3s ease;
}

.journal-textarea:focus {
  border-color: #C3521A;
  box-shadow: 0 0 0 0.2rem rgba(195, 82, 26, 0.15);
}

/* Journal Input Fields */
.journal-input {
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 12px 16px;
  font-size: 1.05rem;
  transition: all 0.3s ease;
}

.journal-input:focus {
  border-color: #C3521A;
  box-shadow: 0 0 0 0.2rem rgba(195, 82, 26, 0.15);
}

/* Button Group */
.button-group {
  display: flex;
  gap: 12px;
  justify-content: center;
}

.btn-secondary {
  background: #e9ecef;
  color: #495057;
  border: 2px solid #dee2e6;
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.btn-secondary:hover {
  background: #dee2e6;
  color: #343a40;
  border-color: #adb5bd;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.btn-primary {
  background: linear-gradient(135deg, #C3521A 0%, #E67E3C 100%);
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(195, 82, 26, 0.3);
}

/* Responsive */
@media (max-width: 576px) {
  .reflect-container {
    padding: 40px 16px;
  }

  .prompt-card {
    padding: 24px;
  }

  .button-group {
    flex-direction: column;
  }

  .btn-lg {
    width: 100%;
  }
}
</style>

<script>
// Web Speech API Integration
const speakBtn = document.getElementById('speakBtn');
const journalEntry = document.getElementById('journalEntry');
const recordingStatus = document.getElementById('recordingStatus');
const stopBtn = document.getElementById('stopBtn');
const charCount = document.getElementById('charCount');

// Initialize character count
function updateCharCount() {
  charCount.textContent = journalEntry.value.length;
}
updateCharCount();
journalEntry.addEventListener('input', updateCharCount);

// Check if browser supports Web Speech API
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
let isRecording = false;

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  let finalTranscript = '';
  let interimTranscript = '';

  recognition.onstart = function() {
    isRecording = true;
    recordingStatus.style.display = 'flex';
    speakBtn.textContent = 'üî¥ Recording...';
    speakBtn.classList.add('active');
  };

  recognition.onresult = function(event) {
    interimTranscript = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;

      if (event.results[i].isFinal) {
        finalTranscript += transcript + ' ';
      } else {
        interimTranscript += transcript;
      }
    }

    // Update textarea with final + interim results
    journalEntry.value = finalTranscript + interimTranscript;
    updateCharCount();
  };

  recognition.onerror = function(event) {
    console.error('Speech recognition error:', event.error);
    stopRecording();

    if (event.error === 'not-allowed') {
      alert('Microphone access denied. Please enable microphone permissions in your browser settings.');
    } else if (event.error === 'no-speech') {
      alert('No speech detected. Please try again.');
    }
  };

  recognition.onend = function() {
    if (isRecording) {
      // Auto-restart if still in recording mode
      recognition.start();
    } else {
      stopRecording();
    }
  };

  // Speak button click
  speakBtn.addEventListener('click', function() {
    if (!isRecording) {
      startRecording();
    } else {
      stopRecording();
    }
  });

  // Stop button click
  stopBtn.addEventListener('click', function() {
    stopRecording();
  });

  function startRecording() {
    try {
      // Store current text before starting
      finalTranscript = journalEntry.value;
      recognition.start();
    } catch (error) {
      console.error('Failed to start recording:', error);
      alert('Failed to start recording. Please try again.');
    }
  }

  function stopRecording() {
    isRecording = false;
    recognition.stop();
    recordingStatus.style.display = 'none';
    speakBtn.textContent = 'üé§ Speak';
    speakBtn.classList.remove('active');
  }
} else {
  // Disable speak button if Web Speech API not supported
  speakBtn.disabled = true;
  speakBtn.textContent = 'üé§ Not Supported';
}

// Make sure we stop recording when leaving the page
window.addEventListener('beforeunload', function() {
  if (isRecording && recognition) {
    stopRecording();
  }
});
</script>
{% endblock %}
